<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head th:fragment="head">
    <!-- Required meta tags -->
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>

    <!--<META HTTP-EQUIV="Access-Control-Allow-Origin" CONTENT="http://localhost:8080/adminPage/json-users">-->
    <!--<meta id="_csrf" name="_csrf" th:content="${_csrf.token}"/>
    <meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}"/>-->

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css"
          integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.10/css/jquery.dataTables.css"/>


    <link th:rel="stylesheet" rel="stylesheet" type="text/css" th:href="@{/css/style.css}"/>
   <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>

  <script>
 

  function loadExpenseTableData() {
	  var totalExpenses = 0;
		$.ajax({
		    type:"get",
		    url:"/transaction/expense/"+localStorage.getItem("userId"),
		    contentType: 'application/json',
		    headers: {
				"Authorization": "Bearer "+localStorage.getItem("token")
			},
		    success: function(result){
				var res = JSON.stringify(result);
				accountList = result;
				$("#expenseTableData").empty();
				var expenseData = "<table class='table table-hover'><thead><tr><th scope='col'>#</th><th scope='col'>Name</th><th scope='col'>Date</th><th scope='col'>Amount</th></tr></thead><tbody>";
				var count = 1;
				for(var i in accountList) { 
					expenseData=expenseData+"<tr><th scope='row'>"+count+"</th><td><b>"+accountList[i].title+"</b></td><td>"+accountList[i].date+"</td><td><b> $"+accountList[i].amount+"</b></td><td></tr>";
					count = count+1;
					totalExpenses = totalExpenses + accountList[i].amount;
				}
				expenseData=expenseData+"</tbody></table>";
				$("#expenseTableData").html(expenseData);
				$(".totalExpenseSpent").html("$"+totalExpenses);
				
		    },error: function(err){
			}
		});
  	}
  	
  	function loadIncomeTableData() {
	 var totalIncome = 0;
		$.ajax({
		    type:"get",
		    url:"/transaction/income/"+localStorage.getItem("userId"),
		    contentType: 'application/json',
		    headers: {
				"Authorization": "Bearer "+localStorage.getItem("token")
			},
		    success: function(result){
				var res = JSON.stringify(result);
				accountList = result;
				$("#incomeTableData").empty();
				var expenseData = "<table class='table table-hover'><thead><tr><th scope='col'>#</th><th scope='col'>Name</th><th scope='col'>Date</th><th scope='col'>Amount</th></tr></thead><tbody>";
				var count = 1;
				for(var i in accountList) { 
					expenseData=expenseData+"<tr><th scope='row'>"+count+"</th><td><b>"+accountList[i].title+"</b></td><td>"+accountList[i].date+"</td><td><b>$"+accountList[i].amount+"</b></td><td></tr>";
					count = count+1;
					totalIncome = totalIncome + accountList[i].amount;
				}
				expenseData=expenseData+"</tbody></table>";
				$("#incomeTableData").html(expenseData);
				$(".totalIncomeEarned").html("$"+totalIncome);
		    },error: function(err){
			}
		});
  	}
  	
	const d = new Date();
	
$(document).ready(function(){
	if(localStorage.getItem("userId") !=="" && localStorage.getItem("userId") !== null 
	&& localStorage.getItem("userId") !== undefined){
		$('#usernameValue').text(localStorage.getItem("firstName")+" "+localStorage.getItem("lastName"));
		$(".userName").attr("style", "display:block;");
		$(".loginButton").attr("style", "display:none;");
	} else {
		$(".userName").attr("style", "display:none;");
		$(".loginButton").attr("style", "display:block;");
	}
	
	$("#accountModalPanel").click(function(){
		$("#accountModal").modal("show");
	})
	
	$("#categoryModalPanel").click(function(){
		$("#categoryModal").modal("show");
	})
	
	$.ajax({
		    type:"get",
		    url:"/transaction/currentBalance/"+localStorage.getItem("userId"),
		    contentType: 'application/json',
		    headers: {
				"Authorization": "Bearer "+localStorage.getItem("token")
			},
		    success: function(result){
				var res = JSON.stringify(result);
				accountList = result;
				$("#balance").empty();
				var balance = '<H5 style="margin-top:10px; color:green">Balance: $'+result+'</H5>'
				$("#balance").html(balance);
		    },error: function(err){
			}
		});
	
	$("#categorySubmit").click(function(){
		var data = {}
	    data["title"] = $("#categoryName").val();
	    data["description"] = $("#categoryDesc").val();
	    data["type"] = $("#categoryType").val();
	    data["userId"] = localStorage.getItem("userId");
		$.ajax({
		    type:"post",
		    data: JSON.stringify(data),
		    url:"/category",
		    contentType: 'application/json',
		    headers: {
				"Authorization": "Bearer "+localStorage.getItem("token")
			},
		    success: function(result){
				$("#categoryModal").modal('hide');
				$("#categoryAddeddSuccessAlert").modal("show");
				$("#categoryName").val("");
			    $("#categoryDesc").val("");
			    $("#categoryType").val("");
			    loadCategoryTableData();
		    },error: function(err){
			}
		});
	});


	$("#accountSubmit").click(function(){
		var data = {}
	    data["name"] = $("#accountName").val();
	    data["type"] = $("#accountType").val();
	    data["userId"] = localStorage.getItem("userId");
		$.ajax({
		    type:"post",
		    data: JSON.stringify(data),
		    url:"/account",
		    contentType: 'application/json',
		    headers: {
				"Authorization": "Bearer "+localStorage.getItem("token")
			},
		    success: function(result){
				$("#accountModal").modal('hide');
				$("#accountAddeddSuccessAlert").modal("show");
				$("#accountName").val("");
	    		$("#accountType").val("");
	    		loadAccountTableData();
		    },error: function(err){
			}
		});
	});
	
	$("#expenseSubmit").click(function(){
		var data = {}
	    data["title"] = $("#expenseName").val();
	    data["amount"] = $("#expenseAmount").val();
	    data["categoryId"] = $("#selectedCategory").val();
	    data["accountId"] = $("#selectedAccount").val();
	    data["type"] = "expense";
	    data["userId"] = localStorage.getItem("userId");
	    data["date"] = $("#expenseDatepicker").val();
		$.ajax({
		    type:"post",
		    data: JSON.stringify(data),
		    url:"/transaction",
		    contentType: 'application/json',
		    headers: {
				"Authorization": "Bearer "+localStorage.getItem("token")
			},
		    success: function(result){
				$("#addExpenseModal").modal('hide');
				$("#expenseAddeddSuccessAlert").modal("show");
				$("#expenseName").val("");
			    $("#expenseAmount").val("");
			    $("#selectedCategory").val("");
			    $("#selectedAccount").val("");
			    $("#expenseDatepicker").val("");
			    loadExpenseTableData();
			    loadBudgetTableData();
		    },error: function(err){
			}
		});
	});


	$("#incomeSubmit").click(function(){
		var data = {}
	    data["title"] = $("#incomeName").val();
	    data["amount"] = $("#incomeAmount").val();
	    data["categoryId"] = $("#selectedCategory").val();
	    data["accountId"] = $("#selectedAccount").val();
	    data["type"] = "income";
	    data["userId"] = localStorage.getItem("userId");
	    data["date"] = $("#incomeDatepicker").val();
		$.ajax({
		    type:"post",
		    data: JSON.stringify(data),
		    url:"/transaction",
		    contentType: 'application/json',
		    headers: {
				"Authorization": "Bearer "+localStorage.getItem("token")
			},
		    success: function(result){
				$("#addIncomeModal").modal('hide');
				$("#incomeAddeddSuccessAlert").modal("show");
				$("#incomeName").val("");
			    $("#incomeAmount").val("");
			    $("#selectedCategory").val("");
			    $("#selectedAccount").val("");
			    $("#incomeDatepicker").val("");
			    loadIncomeTableData();
			    loadBudgetTableData();
		    },error: function(err){
			}
		});
	});

});

	var totalSpent = 0;
	var totalEarn=0;
	var totalEstiSpent=0;
	var totalEstiEarn=0;
	var spentPercentage=0;
	var earnPercentage=0; 
  	function loadBudgetTableData() {
		$.ajax({
		    type:"get",
		    url:"/budget/"+localStorage.getItem("userId")+"/"+monthNames[d.getMonth()]+"/"+new Date().getFullYear(),
		    contentType: 'application/json',
		    headers: {
				"Authorization": "Bearer "+localStorage.getItem("token")
			},
		    success: function(result){
				var res = JSON.stringify(result);
				accountList = result;
				$("#budgetTableData").empty();
				var expenseData = "";
				for(var i in accountList.budgetTableResponse) { 
					expenseData=expenseData+"<br><br><div class='card' style='background-color:#EEF2FC !important'><div class='card-body'><div class='row'><div class='col-3 mx-auto' style='margin-top:18px'><h4>"+accountList.budgetTableResponse[i].categoryName+"</h4></div><div class='col-3 mx-auto'><h4>$"+accountList.budgetTableResponse[i].price;
					if(accountList.budgetTableResponse[i].type==='expense'){
						expenseData=expenseData+"</h4><small style='font-family: cursive;'>spent</small></div><div class='col-3 mx-auto'><h4>$"+accountList.budgetTableResponse[i].estimatedPrice+"</h4><small style='font-family: cursive;'>esti. expense</small></div><div class='col-3 mx-auto'><h4>$"+accountList.budgetTableResponse[i].price+"/$"+accountList.budgetTableResponse[i].estimatedPrice+"</h4><small style='font-family: cursive;'>Progress</small></div></div></div></div>";
					} else {
						expenseData=expenseData+"</h4><small style='font-family: cursive;'>earned</small></div><div class='col-3 mx-auto'><h4>$"+accountList.budgetTableResponse[i].estimatedPrice+"</h4><small style='font-family: cursive;'>esti. income</small></div><div class='col-3 mx-auto'><h4>$"+accountList.budgetTableResponse[i].price+"/$"+accountList.budgetTableResponse[i].estimatedPrice+"</h4><small style='font-family: cursive;'>Progress</small></div></div></div></div>";
					}
				}
				totalSpent = accountList.totalSpent;
				totalEarn = accountList.totalEarn;
				totalEstiSpent = accountList.totalEstiSpent;
				totalEstiEarn = accountList.totalEstiEarn;
				spentPercentage = accountList.spentPercentage;
				earnPercentage = accountList.earnPercentage;
				
				$('.totalIncomeSpentPercent').text(earnPercentage+"%");
				$('.totalExpenseSpentPercent').text(spentPercentage+"%");
				$('.totalExpenseSpent').text("$"+totalSpent+" out of $"+totalEstiSpent);
				$('.totalIncomeSpent').text("$"+totalEarn+" out of $"+totalEstiEarn);
				$('.progressIncomeCircle').attr("data-value", earnPercentage);
				$('.progressExpenseCircle').attr("data-value", spentPercentage);
				$("#budgetTableData").html(expenseData);
				
				$(".progressIncomeCircle").each(function() {
			    var value = earnPercentage;
			    var left = $(this).find('.progress-left .progress-bar');
			    var right = $(this).find('.progress-right .progress-bar');
			
			    if (value > 0) {
			      if (value <= 50) {
			        right.css('transform', 'rotate(' + percentageToDegrees(value) + 'deg)')
			      } else {
			        right.css('transform', 'rotate(180deg)')
			        left.css('transform', 'rotate(' + percentageToDegrees(value - 50) + 'deg)')
			      }
			    }
			
			  })
			  
			  $(".progressExpenseCircle").each(function() {
			
			    var value = spentPercentage;
			    var left = $(this).find('.progress-left .progress-bar');
			    var right = $(this).find('.progress-right .progress-bar');
			
			    if (value > 0) {
			      if (value <= 50) {
			        right.css('transform', 'rotate(' + percentageToDegrees(value) + 'deg)')
			      } else {
			        right.css('transform', 'rotate(180deg)')
			        left.css('transform', 'rotate(' + percentageToDegrees(value - 50) + 'deg)')
			      }
			    }
			
			  })
				
				
		    },error: function(err){
			}
		});
  	}

function logoutClick(){
	$(".userName").attr("style", "display:none;");
	$(".loginButton").attr("style", "display:block;");
	localStorage.removeItem("userId");
	localStorage.removeItem("firstName");
	localStorage.removeItem("lastName");
	localStorage.removeItem("token");
	
	window.location.replace("/");
}

</script>
</head>
<body>


<div th:replace="fragments/jsScripts :: scripts"></div>

 
   
</body>
</html>